//@version=5

// # ========================================================================= #
// #                   |   Indicator  |
// # ========================================================================= #
indicator(
 title                = "Cut lost Position finder",
 shorttitle           = "CLPFinder",
 overlay              =  true
 )
// # ========================================================================= #
// #                   |   Indicator  |
// # ========================================================================= #



// Variable initialization
var float mPosition = 0.0
var float INPUT_CUT_LOST_PRICE = na
var mCutLossLine = line.new(bar_index - 1, close, bar_index, close, extend = extend.both, width = 1, color = color.fuchsia)
var label mPositionLabel = na

// Define functions
getText() =>
    output = "開 " + str.tostring(value = mPosition, format = "#.###") + " " + syminfo.basecurrency + "\n"
    output += "倉位價值 : " + str.tostring(value = mPosition * close, format =  "#")  + " " + syminfo.currency
    output

newLabel(labelText) =>
    output = label.new(
     x            =  bar_index + 2,
     y            =  close,
     text         =  labelText,
    //  xloc         =  ,
    //  yloc         =  ,
     color        =  color.new(color =  color.purple, transp = 0),
     style        =  label.style_label_left,
     textcolor    =  color.new(color =  color.white, transp = 0)
    //  size         =  ,
    //  textalign    =  ,
    //  tooltip      = "" 
     )
    output


// Define inputs settings
var GROUP_SETTING = "📌 設定"
var GROUN_VERSION = "💬 關於"
var VERSION_NAME = "v1.0"
var RELEASE_NOTE = VERSION_NAME + " Release note :" + "\n" + 
                     "[1] First release version." + "\n"


INPUT_EACH_ORDER_LOST = input.float(defval = 5.0, title = "每單止損", minval = 1.0, maxval =  10000.0, step =  1, tooltip = "調整每單止損金額", group = GROUP_SETTING) 
INPUT_CUT_LOST_PRICE := input.price(defval = 0.0, title = "止損價格", confirm = true, group = GROUP_SETTING) 
INPUT_DISPLAY_VERSION_NAME = input.string(defval = VERSION_NAME, title = "版本", options = [VERSION_NAME], tooltip = RELEASE_NOTE, group = GROUN_VERSION) 



// Code logic start
if barstate.islast
    mPosition := INPUT_EACH_ORDER_LOST / (1 - ((close - math.abs(close - INPUT_CUT_LOST_PRICE)) / close)) / close
    mPositionLabel = newLabel(getText())
    label.delete(id = mPositionLabel[1])

    line.set_xy1(mCutLossLine, bar_index - 1, INPUT_CUT_LOST_PRICE)
    line.set_xy2(mCutLossLine, bar_index, INPUT_CUT_LOST_PRICE)


